import{j as t,u as v,r as d,A as j,b as Y,p as q,D as k,q as _,w as $,x as O,e as ee,y as te}from"./index-B5N-jUy8.js";import{c as L,T as ne,a as M,B as se,b,D as oe,I as re,d as ae,e as C,g as P,f as A,L as E,S as U,u as ie,P as le,v as N}from"./App-BP_5kTt-.js";import{S as ce}from"./Star-DGhqYad1.js";import{B as ue,D as de}from"./DbRenewReminder-ucHVCTRy.js";import{S as pe}from"./index-DyT5RaID.js";import{u as xe,d as ge}from"./hooks-C2CplNbh.js";import{l as y,M as he,T as me,L as fe,a as be,C as je}from"./TileLayer-ISEXnMHk.js";import{D as Ce}from"./DialogTitle-D8V2UwC_.js";import{C as ye}from"./Close-IMv9MwNm.js";import{S as ve}from"./Slider-Csqlhd_s.js";import{T as Re,a as W}from"./ToggleButtonGroup--V0Cf5x2.js";import{t as Se}from"./index-CJ_zZ9Gs.js";const Te=L([t.jsx("circle",{cx:"12",cy:"17",r:"4"},"0"),t.jsx("path",{d:"M12 10.07c1.95 0 3.72.79 5 2.07l5-5C19.44 4.59 15.9 3 12 3S4.56 4.59 2 7.15l5 5c1.28-1.28 3.05-2.08 5-2.08"},"1")],"CompassCalibration"),Ie=L(t.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),De=L(t.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),ke=({homeTab:e,onChangeTab:s})=>{const{t:n}=v(),{collections:o}=d.useContext(j);return t.jsxs(ne,{value:e,onChange:(l,i)=>s(i,!0),sx:we,variant:"scrollable",scrollButtons:!0,children:[t.jsx(M,{iconPosition:"start",icon:t.jsx(Te,{}),label:n("附近"),value:"nearby",disableRipple:!0}),t.jsx(M,{iconPosition:"start",icon:t.jsx(ce,{}),label:n("常用"),value:"saved",disableRipple:!0}),t.jsx(M,{iconPosition:"start",icon:t.jsx(se,{}),label:n("Collections"),value:"collections",disableRipple:!0}),o.map((l,i)=>t.jsx(M,{label:l.name,value:l.name,disableRipple:!0},`collection-${i}`))]})},Me=(e,s)=>{if(e==="saved"||e==="nearby"||e==="collections")return!0;for(let n=0;n<s.length;++n)if(e===s[n].name)return!0;return!1},we={background:e=>e.palette.background.default,minHeight:"36px","& .MuiTab-root":{textTransform:"none",alignItems:"center",justifyContent:"center",paddingTop:0,paddingBottom:0,minHeight:"32px"},"& .MuiTabs-flexContainer":{justifyContent:"flex-start"}};y.Icon.Default.mergeOptions({iconUrl:null,iconRetinaUrl:null,shadowUrl:null,iconSize:null,iconAnchor:null,popupAnchor:null,tooltipAnchor:null,shadowSize:null,classNamePrefix:"leaflet-default-icon-"});y.Icon.Default.include({_needsInit:!0,_getIconUrl:function(e){var s=this.options.imagePath||y.Icon.Default.imagePath||"";return this._needsInit&&this._initializeOptions(s),s+y.Icon.prototype._getIconUrl.call(this,e)},_initializeOptions:function(e){this._setOptions("icon",z,e),this._setOptions("shadow",z,e),this._setOptions("popup",G),this._setOptions("tooltip",G),this._needsInit=!1},_setOptions:function(e,s,n){var o=this.options,l=o.classNamePrefix,i=s(l+e,n);for(var r in i)o[e+r]=o[e+r]||i[r]}});function z(e,s){var n=y.DomUtil.create("div",e,document.body),o=$e(n),l=_e(o,s),i=I(n,"width"),r=I(n,"height"),u=I(n,"margin-left"),c=I(n,"margin-top");return n.parentNode.removeChild(n),{Url:l[0],RetinaUrl:l[1],Size:[i,r],Anchor:[-u,-c]}}function G(e){var s=y.DomUtil.create("div",e,document.body),n=I(s,"margin-left"),o=I(s,"margin-top");return s.parentNode.removeChild(s),{Anchor:[n,o]}}function _e(e,s){for(var n=/url\(['"]?([^"']*?)['"]?\)/gi,o=[],l=n.exec(e);l;)o.push(s?Oe(l[1]):l[1]),l=n.exec(e);return o}function Oe(e){return e.substr(e.lastIndexOf("/")+1)}function I(e,s){return parseInt(B(e,s),10)}function B(e,s){return y.DomUtil.getStyle(e,s)||y.DomUtil.getStyle(e,He(s))}function $e(e){var s=B(e,"background-image");return s&&s!=="none"?s:B(e,"cursor")}function He(e){return e.replace(/-(\w)/g,function(s,n){return n.toUpperCase()})}const Be=Y.forwardRef(({range:e,value:s,onChange:n},o)=>{const l=d.useRef(null),i=d.useRef(null),r=d.useRef(s).current,{geolocation:u,colorMode:c}=d.useContext(j),[a,g]=d.useState(null);d.useImperativeHandle(o,()=>a,[a]);const p=d.useCallback(()=>{var x,f;a!==null&&((x=l.current)==null||x.setLatLng(a.getCenter()),(f=i.current)==null||f.setLatLng(a.getCenter()),n(a.getCenter()))},[n,a]);return d.useEffect(()=>(a==null||a.on("move",p),()=>{a==null||a.off("move",p)}),[p,a]),t.jsxs(he,{style:{height:"100%",position:"relative"},center:r,zoom:Le,scrollWheelZoom:!1,ref:g,children:[t.jsx(me,{crossOrigin:"anonymous",maxZoom:fe.Browser.retina?20:19,maxNativeZoom:18,keepBuffer:10,updateWhenIdle:!1,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',url:c==="light"?"https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png":"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png"}),t.jsx(be,{position:r,ref:l}),t.jsx(je,{center:r,radius:e,ref:i}),t.jsx(Ee,{map:a,onChange:n}),t.jsx(Ue,{onClick:()=>{a==null||a.setView(u,a==null?void 0:a.getZoom(),{animate:!0})}})]})}),Le=14,Ee=({map:e,onChange:s})=>(xe("click",n=>{e.setView(n.latlng,e.getZoom(),{animate:!0}),s(n.latlng)}),null),Ue=({onClick:e})=>t.jsx("div",{className:"leaflet-bottom leaflet-right",children:t.jsx(b,{sx:Fe,className:"leaflet-control leaflet-bar",onClick:e,children:t.jsx(ge,{className:J.centerControl})})}),T="range-map",J={mapContainerBox:`${T}-mapContainerBox`,mapContainer:`${T}-mapContainer`,centerControl:`${T}-centerControl`,marker:`${T}-marker`,active:`${T}-active`,passed:`${T}-passed`},Fe={background:"white",width:32,height:32,marginBottom:"20px !important",marginRight:"5px !important",display:"flex",justifyContent:"center",alignItems:"center",[`& .${J.centerControl}`]:{padding:"3px",color:"black"}},Pe=({open:e,onClose:s})=>{const{geolocation:n,manualGeolocation:o,searchRange:l,setManualGeolocation:i,setSearchRange:r}=d.useContext(j),{t:u}=v(),[c,a]=d.useState({geolocation:o??n,searchRange:l}),g=d.useCallback(()=>{i(c.geolocation),r(c.searchRange),s()},[c,i,r,s]),p=d.useCallback(h=>{a(m=>({...m,geolocation:h}))},[]),x=d.useCallback(h=>{a(m=>({...m,searchRange:h}))},[]),f=d.useCallback(h=>{const{distance:m,unit:R}=q(h);return`${m}${u(R)}`},[u]);return t.jsxs(oe,{open:e,onClose:g,sx:Ae,children:[t.jsxs(Ce,{sx:Ne,children:[u("自訂搜尋範圍"),t.jsx(re,{onClick:g,children:t.jsx(ye,{})})]}),t.jsxs(ae,{children:[t.jsx(Be,{range:c.searchRange,value:c.geolocation,onChange:p}),t.jsx(b,{sx:{px:4,py:5},children:t.jsx(ve,{sx:We,"aria-label":"Range",value:H(c.searchRange,w,S),valueLabelDisplay:"on",marks:S.map((h,m)=>({label:f(w[m]),value:h})),min:S[0],max:S[S.length-1],step:250,scale:h=>H(h,S,w),valueLabelFormat:h=>f(h),onChange:(h,m)=>x(H(m,S,w))})})]})]})},Ae={"& .MuiPaper-root":{width:"100%",height:"calc(100dvh - 100px)"},"& .MuiDialogContent-root":{p:0,display:"flex",flexDirection:"column"}},Ne={backgroundColor:e=>e.palette.background.default,color:e=>e.palette.primary.main,display:"flex",justifyContent:"space-between"},We={"& .MuiSlider-mark":{backgroundColor:"#bfbfbf",height:8}},S=[0,1e3,2e3,3e3,4e3,5e3],w=[20,100,200,400,2e3,4e3],H=(e,s,n)=>{if(e<=s[0])return n[0];for(let o=1;o<s.length;++o)if(e<=s[o])return n[o-1]+(e-s[o-1])*(n[o]-n[o-1])/(s[o]-s[o-1]);return n[n.length-1]},ze=()=>{const{t:e}=v(),{searchRange:s,setSearchRange:n}=d.useContext(j),[o,l]=d.useState(!1);return t.jsxs(b,{sx:Ge,children:[t.jsxs(C,{variant:"caption",children:[e("搜尋範圍（米）"),":"]}),t.jsxs(Re,{value:k.includes(s)?s:"custom",onChange:(i,r)=>{k.includes(r)?n(r):l(!0)},"aria-label":"search range",size:"small",exclusive:!0,children:[k.map(i=>{const{distance:r}=q(i);return t.jsx(W,{sx:V,disableRipple:!0,value:i,"aria-label":i.toString(),children:r},`range-${i}`)}),t.jsxs(W,{sx:V,disableRipple:!0,value:"custom","aria-label":"custom",children:[e("自訂"),!k.includes(s)&&`(${s})`]},"range-custom")]}),t.jsx(Pe,{open:o,onClose:()=>l(!1)})]})},Ge={position:"sticky",top:0,display:"flex",justifyContent:"space-around",alignItems:"center",flexWrap:"wrap",listStyle:"none",px:0,py:1,m:0,borderRadius:0,fontSize:14,borderBottomWidth:1,borderBottomColor:e=>e.palette.mode==="dark"?P[900]:P[200],borderBottomStyle:"solid"},V={height:30,px:2},K=({name:e,routeStrings:s,defaultExpanded:n=!0})=>{const[o,l]=d.useState(n),i=d.useMemo(()=>s.split("|").filter(r=>r)??[],[s]);return i.length===0?t.jsx(t.Fragment,{}):t.jsxs(b,{children:[t.jsxs(b,{sx:Ve,onClick:()=>l(r=>!r),children:[t.jsx(C,{variant:"body1",m:1,fontWeight:700,children:e}),t.jsx(b,{children:o?t.jsx(Ie,{}):t.jsx(De,{})})]}),t.jsx(A,{}),o&&t.jsx(E,{disablePadding:!0,children:i.map((r,u)=>!!r&&t.jsx(U,{routeId:r},`route-${e}-${u}`))}),t.jsx(A,{})]})},Ve={display:"flex",alignItems:"center",justifyContent:"space-between",mx:1,cursor:"pointer"},Ze=({isFocus:e})=>{const{t:s}=v(),{manualGeolocation:n,geolocation:o,db:{routeList:l,stopList:i,serviceDayMap:r},isRouteFilter:u,isTodayHoliday:c,searchRange:a}=d.useContext(j),[g,p]=d.useState(n??o),x=d.useMemo(()=>Se(m=>{p(m)},1e3),[]);d.useEffect(()=>{x(n??o)},[n,o,x]);const f=d.useMemo(()=>Xe({geolocation:g,stopList:i,routeList:l,isRouteFilter:u,isTodayHoliday:c,serviceDayMap:r,searchRange:a}),[g,i,l,u,c,r,a]),h=d.useMemo(()=>Object.values(f).map(m=>m.split("|").every(R=>R==="")).every(Boolean),[f]);return e?h?t.jsx(b,{sx:Z,children:t.jsx(C,{sx:{marginTop:5},fontWeight:"700",children:s("附近未有任何路線")})}):t.jsx(b,{sx:Z,children:Object.entries(f).map(([m,R])=>t.jsx(K,{name:s(m),routeStrings:R},`nearby-${m}`))}):t.jsx(t.Fragment,{})},Xe=({geolocation:e,stopList:s,routeList:n,isRouteFilter:o,isTodayHoliday:l,serviceDayMap:i,searchRange:r})=>{const u=Object.entries(s).map(c=>[...c,_(c[1].location,e)]).filter(c=>c[2]<r).sort((c,a)=>c[2]-a[2]).slice(0,20).reduce((c,[a])=>(Object.entries(n).forEach(([g,p])=>{["kmb","lrtfeeder","lightRail","gmb","ctb","nlb"].forEach(x=>{p.stops[x]&&p.stops[x].includes(a)&&(c[$[x]]===void 0&&(c[$[x]]=[]),c[$[x]].push(g+"/"+p.stops[x].indexOf(a)))})}),c),{bus:[],mtr:[],lightRail:[],minibus:[]});return Object.entries(u).reduce((c,[a,g])=>(c[a]=O(g,l,o,n,s,i,e),c),{})},Z={display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:"100dvh"},Ye=({isFocus:e})=>{const{t:s}=v(),{savedEtas:n,geolocation:o,db:{routeList:l,stopList:i,serviceDayMap:r},isRouteFilter:u,isTodayHoliday:c}=d.useContext(j),a=d.useMemo(()=>qe({savedEtas:n,geolocation:o,stopList:i,routeList:l,isRouteFilter:u,isTodayHoliday:c,serviceDayMap:r}),[n,o,l,i,u,c,r]),g=d.useMemo(()=>a.every(p=>!p),[a]);return e?g?t.jsx(b,{sx:Je,children:t.jsx(C,{sx:{marginTop:5},fontWeight:"700",children:s("未有收藏路線")})}):t.jsx(E,{disablePadding:!0,sx:{minHeight:"100dvh"},children:a.map((p,x)=>!!p&&t.jsx(U,{routeId:p},`route-shortcut-${x}`))}):t.jsx(t.Fragment,{})},qe=({savedEtas:e,geolocation:s,stopList:n,routeList:o,isRouteFilter:l,isTodayHoliday:i,serviceDayMap:r})=>O(e.filter((u,c,a)=>a.indexOf(u)===c&&u.split("/")[0]in o).map((u,c,a)=>{const[g,p]=u.split("/"),x=Object.values(o[g].stops).sort((f,h)=>h.length-f.length)[0];if(p!==void 0&&parseInt(p,10)<x.length)return[u,_(s,n[x[Number(p)]].location),a.length-c];{const f=x.map(h=>[h,_(s,n[h].location)]).sort(([,h],[,m])=>h<m?-1:1)[0][0];return[u,_(s,n[f].location),a.length-c]}}).sort((u,c)=>u[2]-c[2]).map(u=>u[0]).slice(0,40),i,l,o,n,r,s).split("|"),Je={display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:"100dvh"},Ke=({isFocus:e})=>{const{t:s}=v(),{collections:n,geolocation:o,db:{routeList:l,stopList:i,serviceDayMap:r},isRouteFilter:u,isTodayHoliday:c}=d.useContext(j),a=d.useMemo(()=>Qe({collections:n,geolocation:o,stopList:i,routeList:l,isRouteFilter:u,isTodayHoliday:c,serviceDayMap:r}),[n,o,i,l,u,c,r]);return e?a.length===0?t.jsx(b,{sx:X,children:t.jsx(C,{sx:{marginTop:5},fontWeight:700,children:s("未有收藏路線")})}):t.jsxs(b,{sx:X,children:[a.map(({name:g,routes:p,defaultExpanded:x},f)=>t.jsx(K,{name:g,routeStrings:p,defaultExpanded:x},`collection-${f}`)),!a.reduce((g,{routes:p})=>g||p.split("|").filter(x=>!!x).length>0,!1)&&t.jsx(C,{sx:{marginTop:5},fontWeight:700,children:s("未有收藏路線")})]}):t.jsx(t.Fragment,{})},Qe=({collections:e,geolocation:s,stopList:n,routeList:o,isRouteFilter:l,isTodayHoliday:i,serviceDayMap:r})=>e.map(({name:u,list:c,schedules:a})=>({name:u,routes:c,defaultExpanded:a.reduce((g,{day:p,start:x,end:f})=>{if(g)return g;const h=new Date;h.setUTCHours(h.getUTCHours()+8);const m=h.getUTCDay();if(i&&p===0||p===m){let R=x.hour*60+x.minute,Q=f.hour*60+f.minute,F=(h.getUTCHours()*60+h.getUTCMinutes())%1440;return R<=F&&F<=Q}return!1},!1)})).map(u=>({...u,routes:O(u.routes,i,l,o,n,r,s)})),X={display:"flex",flexDirection:"column",gap:2,minHeight:"100dvh"},et=({collection:e,isFocus:s})=>{const{t:n}=v(),{geolocation:o,db:{routeList:l,stopList:i,serviceDayMap:r},isRouteFilter:u,isTodayHoliday:c}=d.useContext(j),a=d.useMemo(()=>tt({savedEtas:e.list,geolocation:o,stopList:i,routeList:l,isRouteFilter:u,isTodayHoliday:c,serviceDayMap:r}),[e,o,i,l,u,c,r]),g=d.useMemo(()=>a.every(p=>!p),[a]);return s?g?t.jsx(b,{sx:nt,children:t.jsx(C,{sx:{marginTop:5},fontWeight:700,children:t.jsx("b",{children:n("收藏中未有路線")})})}):t.jsx(E,{disablePadding:!0,sx:{minHeight:"100dvh"},children:a.map((p,x)=>!!p&&t.jsx(U,{routeId:p},`route-shortcut-${x}`))}):t.jsx(t.Fragment,{})},tt=({savedEtas:e,geolocation:s,stopList:n,routeList:o,isRouteFilter:l,isTodayHoliday:i,serviceDayMap:r})=>O(e,i,l,o,n,r,s).split("|"),nt={display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:"100dvh"},st=Y.forwardRef(({homeTab:e,onChangeTab:s},n)=>{const{collections:o}=d.useContext(j),l=d.useRef(e);d.useImperativeHandle(n,()=>({changeTab:r=>{l.current=r}}));const i=d.useCallback(()=>{let r=D.indexOf(l.current);if(r!==-1)return r;for(let u=0;u<o.length;++u)if(o[u].name===l.current)return u+D.length;return-1},[o]);return t.jsxs(t.Fragment,{children:[e==="nearby"?t.jsx(ze,{}):null,t.jsxs(pe,{index:i(),onChangeIndex:r=>{s(r<D.length?D[r]:o[r-D.length].name)},children:[t.jsx(Ze,{isFocus:e==="nearby"}),t.jsx(Ye,{isFocus:e==="saved"}),t.jsx(Ke,{isFocus:e==="collections"}),o.map(r=>t.jsx(et,{collection:r,isFocus:e===r.name},`list-${r.name}`))]})]})}),D=["nearby","saved","collections"],ft=()=>{const{AppTitle:e,collections:s}=d.useContext(j),{t:n}=v(),o=ee(),{collectionName:l}=ie(),i=d.useRef(null),r=l??localStorage.getItem("homeTab"),[u,c]=d.useState(Me(r,s)?r:"nearby");d.useEffect(()=>{te({title:`${n("Dashboard")} - ${n(e)}`,description:n("home-page-description"),lang:o})},[o]);const a=(g,p=!1)=>{c(g),localStorage.setItem("homeTab",g),i.current&&p&&i.current.changeTab(g)};return t.jsxs(le,{sx:ot,square:!0,elevation:0,children:[t.jsx(C,{component:"h1",style:N,children:`${n("Dashboard")} - ${n(e)}`}),t.jsx(C,{component:"h2",style:N,children:n("home-page-description")}),t.jsx(ke,{homeTab:u,onChangeTab:a}),t.jsx(ue,{}),t.jsx(de,{}),t.jsx(st,{ref:i,homeTab:u,onChangeTab:a})]})},ot={background:e=>e.palette.mode==="dark"?e.palette.background.default:"white",textAlign:"center",display:"flex",flexDirection:"column",overflow:"auto",width:"100%",height:"100%"};export{ft as default};
