import{g as ue,r as O,A as se,u as ce,e as le,J as fe,t as q,Q as re,j as T}from"./index-B5N-jUy8.js";import{C as he}from"./TimeReport-BqvQdMyw.js";import{u as me,aP as de,aQ as ge,b as te,i as ie}from"./App-BP_5kTt-.js";import{S as pe}from"./Snackbar-Ct91Pi67.js";import"./CircularProgress-Bi997K7R.js";var oe={exports:{}};(function(x){(function(h){var i=M(),v=z(),D=K(),X=Y(),R={imagePlaceholder:void 0,cacheBust:!1},d={toSvg:C,toPng:P,toJpeg:E,toBlob:A,toPixelData:p,impl:{fontFaces:D,images:X,util:i,inliner:v,options:{}}};x.exports=d;function C(n,e){return e=e||{},H(e),Promise.resolve(n).then(function(a){return V(a,e.filter,!0)}).then(G).then(J).then(r).then(function(a){return _(a,e.width||i.width(n),e.height||i.height(n))});function r(a){return e.bgcolor&&(a.style.backgroundColor=e.bgcolor),e.width&&(a.style.width=e.width+"px"),e.height&&(a.style.height=e.height+"px"),e.style&&Object.keys(e.style).forEach(function(l){a.style[l]=e.style[l]}),a}}function p(n,e){return N(n,e||{}).then(function(r){return r.getContext("2d").getImageData(0,0,i.width(n),i.height(n)).data})}function P(n,e){return N(n,e||{}).then(function(r){return r.toDataURL()})}function E(n,e){return e=e||{},N(n,e).then(function(r){return r.toDataURL("image/jpeg",e.quality||1)})}function A(n,e){return N(n,e||{}).then(i.canvasToBlob)}function H(n){typeof n.imagePlaceholder>"u"?d.impl.options.imagePlaceholder=R.imagePlaceholder:d.impl.options.imagePlaceholder=n.imagePlaceholder,typeof n.cacheBust>"u"?d.impl.options.cacheBust=R.cacheBust:d.impl.options.cacheBust=n.cacheBust}function N(n,e){return C(n,e).then(i.makeImage).then(i.delay(100)).then(function(a){var l=r(n);return l.getContext("2d").drawImage(a,0,0),l});function r(a){var l=document.createElement("canvas");if(l.width=e.width||i.width(a),l.height=e.height||i.height(a),e.bgcolor){var c=l.getContext("2d");c.fillStyle=e.bgcolor,c.fillRect(0,0,l.width,l.height)}return l}}function V(n,e,r){if(!r&&e&&!e(n))return Promise.resolve();return Promise.resolve(n).then(a).then(function(o){return l(n,o,e)}).then(function(o){return c(n,o)});function a(o){return o instanceof HTMLCanvasElement?i.makeImage(o.toDataURL()):o.cloneNode(!1)}function l(o,u,b){var U=o.childNodes;if(U.length===0)return Promise.resolve(u);return g(u,i.asArray(U),b).then(function(){return u});function g(W,S,y){var j=Promise.resolve();return S.forEach(function(F){j=j.then(function(){return V(F,y)}).then(function(I){I&&W.appendChild(I)})}),j}}function c(o,u){if(!(u instanceof Element))return u;return Promise.resolve().then(b).then(U).then(g).then(W).then(function(){return u});function b(){S(window.getComputedStyle(o),u.style);function S(y,j){y.cssText?j.cssText=y.cssText:F(y,j);function F(I,B){i.asArray(I).forEach(function(t){B.setProperty(t,I.getPropertyValue(t),I.getPropertyPriority(t))})}}}function U(){[":before",":after"].forEach(function(y){S(y)});function S(y){var j=window.getComputedStyle(o,y),F=j.getPropertyValue("content");if(F===""||F==="none")return;var I=i.uid();u.className=u.className+" "+I;var B=document.createElement("style");B.appendChild(t(I,y,j)),u.appendChild(B);function t(s,m,f){var w="."+s+":"+m,$=f.cssText?Z(f):ee(f);return document.createTextNode(w+"{"+$+"}");function Z(k){var L=k.getPropertyValue("content");return k.cssText+" content: "+L+";"}function ee(k){return i.asArray(k).map(L).join("; ")+";";function L(Q){return Q+": "+k.getPropertyValue(Q)+(k.getPropertyPriority(Q)?" !important":"")}}}}}function g(){o instanceof HTMLTextAreaElement&&(u.innerHTML=o.value),o instanceof HTMLInputElement&&u.setAttribute("value",o.value)}function W(){u instanceof SVGElement&&(u.setAttribute("xmlns","http://www.w3.org/2000/svg"),u instanceof SVGRectElement&&["width","height"].forEach(function(S){var y=u.getAttribute(S);y&&u.style.setProperty(S,y)}))}}}function G(n){return D.resolveAll().then(function(e){var r=document.createElement("style");return n.appendChild(r),r.appendChild(document.createTextNode(e)),n})}function J(n){return X.inlineAll(n).then(function(){return n})}function _(n,e,r){return Promise.resolve(n).then(function(a){return a.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),new XMLSerializer().serializeToString(a)}).then(i.escapeXhtml).then(function(a){return'<foreignObject x="0" y="0" width="100%" height="100%">'+a+"</foreignObject>"}).then(function(a){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+e+'" height="'+r+'">'+a+"</svg>"}).then(function(a){return"data:image/svg+xml;charset=utf-8,"+a})}function M(){return{escape:W,parseExtension:e,mimeType:r,dataAsUrl:g,isDataUrl:a,canvasToBlob:c,resolveUrl:o,getAndEncode:U,uid:u(),delay:S,asArray:y,escapeXhtml:j,makeImage:b,width:F,height:I};function n(){var t="application/font-woff",s="image/jpeg";return{woff:t,woff2:t,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:s,jpeg:s,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}function e(t){var s=/\.([^\.\/]*?)$/g.exec(t);return s?s[1]:""}function r(t){var s=e(t).toLowerCase();return n()[s]||""}function a(t){return t.search(/^(data:)/)!==-1}function l(t){return new Promise(function(s){for(var m=window.atob(t.toDataURL().split(",")[1]),f=m.length,w=new Uint8Array(f),$=0;$<f;$++)w[$]=m.charCodeAt($);s(new Blob([w],{type:"image/png"}))})}function c(t){return t.toBlob?new Promise(function(s){t.toBlob(s)}):l(t)}function o(t,s){var m=document.implementation.createHTMLDocument(),f=m.createElement("base");m.head.appendChild(f);var w=m.createElement("a");return m.body.appendChild(w),f.href=s,w.href=t,w.href}function u(){var t=0;return function(){return"u"+s()+t++;function s(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}}function b(t){return new Promise(function(s,m){var f=new Image;f.onload=function(){s(f)},f.onerror=m,f.src=t})}function U(t){var s=3e4;return d.impl.options.cacheBust&&(t+=(/\?/.test(t)?"&":"?")+new Date().getTime()),new Promise(function(m){var f=new XMLHttpRequest;f.onreadystatechange=Z,f.ontimeout=ee,f.responseType="blob",f.timeout=s,f.open("GET",t,!0),f.send();var w;if(d.impl.options.imagePlaceholder){var $=d.impl.options.imagePlaceholder.split(/,/);$&&$[1]&&(w=$[1])}function Z(){if(f.readyState===4){if(f.status!==200){w?m(w):k("cannot fetch resource: "+t+", status: "+f.status);return}var L=new FileReader;L.onloadend=function(){var Q=L.result.split(/,/)[1];m(Q)},L.readAsDataURL(f.response)}}function ee(){w?m(w):k("timeout of "+s+"ms occured while fetching resource: "+t)}function k(L){console.error(L),m("")}})}function g(t,s){return"data:"+s+";base64,"+t}function W(t){return t.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")}function S(t){return function(s){return new Promise(function(m){setTimeout(function(){m(s)},t)})}}function y(t){for(var s=[],m=t.length,f=0;f<m;f++)s.push(t[f]);return s}function j(t){return t.replace(/#/g,"%23").replace(/\n/g,"%0A")}function F(t){var s=B(t,"border-left-width"),m=B(t,"border-right-width");return t.scrollWidth+s+m}function I(t){var s=B(t,"border-top-width"),m=B(t,"border-bottom-width");return t.scrollHeight+s+m}function B(t,s){var m=window.getComputedStyle(t).getPropertyValue(s);return parseFloat(m.replace("px",""))}}function z(){var n=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:l,shouldProcess:e,impl:{readUrls:r,inline:a}};function e(c){return c.search(n)!==-1}function r(c){for(var o=[],u;(u=n.exec(c))!==null;)o.push(u[1]);return o.filter(function(b){return!i.isDataUrl(b)})}function a(c,o,u,b){return Promise.resolve(o).then(function(g){return u?i.resolveUrl(g,u):g}).then(b||i.getAndEncode).then(function(g){return i.dataAsUrl(g,i.mimeType(o))}).then(function(g){return c.replace(U(o),"$1"+g+"$3")});function U(g){return new RegExp(`(url\\(['"]?)(`+i.escape(g)+`)(['"]?\\))`,"g")}}function l(c,o,u){if(b())return Promise.resolve(c);return Promise.resolve(c).then(r).then(function(U){var g=Promise.resolve(c);return U.forEach(function(W){g=g.then(function(S){return a(S,W,o,u)})}),g});function b(){return!e(c)}}}function K(){return{resolveAll:n,impl:{readAll:e}};function n(){return e().then(function(r){return Promise.all(r.map(function(a){return a.resolve()}))}).then(function(r){return r.join(`
`)})}function e(){return Promise.resolve(i.asArray(document.styleSheets)).then(a).then(r).then(function(c){return c.map(l)});function r(c){return c.filter(function(o){return o.type===CSSRule.FONT_FACE_RULE}).filter(function(o){return v.shouldProcess(o.style.getPropertyValue("src"))})}function a(c){var o=[];return c.forEach(function(u){try{i.asArray(u.cssRules||[]).forEach(o.push.bind(o))}catch(b){console.log("Error while reading CSS rules from "+u.href,b.toString())}}),o}function l(c){return{resolve:function(){var u=(c.parentStyleSheet||{}).href;return v.inlineAll(c.cssText,u)},src:function(){return c.style.getPropertyValue("src")}}}}}function Y(){return{inlineAll:e,impl:{newImage:n}};function n(r){return{inline:a};function a(l){return i.isDataUrl(r.src)?Promise.resolve():Promise.resolve(r.src).then(l||i.getAndEncode).then(function(c){return i.dataAsUrl(c,i.mimeType(r.src))}).then(function(c){return new Promise(function(o,u){r.onload=o,r.onerror=u,r.src=c})})}}function e(r){if(!(r instanceof Element))return Promise.resolve(r);return a(r).then(function(){return r instanceof HTMLImageElement?n(r).inline():Promise.all(i.asArray(r.childNodes).map(function(l){return e(l)}))});function a(l){var c=l.style.getPropertyValue("background");return c?v.inlineAll(c).then(function(o){l.style.setProperty("background",o,l.style.getPropertyPriority("background"))}).then(function(){return l}):Promise.resolve(l)}}}})()})(oe);var ve=oe.exports;const ye=ue(ve);var we={format:"image/png",quality:.92,width:void 0,height:void 0,Canvas:void 0,crossOrigin:void 0},xe=function(x,h){return x===void 0&&(x=[]),h===void 0&&(h={}),new Promise(function(i){h=Object.assign({},we,h);var v=h.Canvas?new h.Canvas:window.document.createElement("canvas"),D=h.Image||window.Image,X=x.map(function(d){return new Promise(function(C,p){d.constructor.name!=="Object"&&(d={src:d});var P=new D;P.crossOrigin=h.crossOrigin,P.onerror=function(){return p(new Error("Couldn't load image"))},P.onload=function(){return C(Object.assign({},d,{img:P}))},P.src=d.src})}),R=v.getContext("2d");i(Promise.all(X).then(function(d){var C=function(p){return h[p]||Math.max.apply(Math,d.map(function(P){return P.img[p]}))};return v.width=C("width"),v.height=C("height"),d.forEach(function(p){return R.globalAlpha=p.opacity?p.opacity:1,R.drawImage(p.img,p.x||0,p.y||0)}),h.Canvas&&h.format==="image/jpeg"?new Promise(function(p,P){v.toDataURL(h.format,{quality:h.quality,progressive:!1},function(E,A){if(E){P(E);return}p(A)})}):v.toDataURL(h.format,h.quality)}))})};const Be=({routeId:x,seq:h=-1,stopId:i,event:v})=>{const[{isOpen:D,isCopied:X},R]=O.useState(Pe),{AppTitle:d,colorMode:C,db:{routeList:p,stopList:P}}=O.useContext(se),{t:E}=ce(),A=le(),[H,N]=O.useState(""),{id:V}=me(),{route:G,dest:J}=p[x],_=P[i],M=O.useCallback(n=>R(e=>({...e,isOpen:n})),[]),z=O.useCallback(n=>R(e=>({...e,isCopied:n})),[]);O.useEffect(()=>(D&&Promise.all([ne("route-eta-header",C),ne("route-map",C),ne(`stop-${h}`,C)]).then(n=>{let e=0;return xe(n.filter(([r])=>r).map(([r,a])=>(e+=a,{src:r,x:0,y:e-a})),{height:e})}).then(n=>{N(n)}),()=>{N("")}),[D,C,h]),O.useEffect(()=>{v&&M(!0)},[M,v]);const K=O.useCallback(()=>{fe(`https://${window.location.hostname}/${A}/route/${V}/${i}%2C${h}`,`${h+1}. ${q(_.name[A])} - ${G} ${E("往")} ${q(J[A])} - ${E(d)}`).then(()=>{navigator.clipboard&&z(!0)}).finally(()=>{M(!1)})},[d,V,J,E,z,A,h,_.name,i,G,M]),Y=O.useCallback(()=>{re(H,`https://${window.location.hostname}/${A}/route/${V}/${i}%2C${h}`,`${h+1}. ${q(_.name[A])} - ${G} ${E("往")} ${q(J[A])} - https://hkbus.app/`).then(()=>{navigator.clipboard&&z(!0)}).finally(()=>{M(!1)})},[re,H,A,V,h,G,navigator]);return T.jsxs(T.Fragment,{children:[T.jsx(de,{sx:be,onClose:()=>M(!1),open:D,children:T.jsx(ge,{maxWidth:"xs",sx:Ce,fixed:!0,children:T.jsxs(te,{sx:Ee,children:[T.jsx(te,{sx:Ae,children:H?T.jsx("img",{src:H,style:{objectFit:"contain",width:396,height:400},alt:""}):T.jsx(he,{color:"inherit"})}),T.jsxs(te,{sx:Se,children:[T.jsx(ie,{sx:ae,onClick:K,children:E("以鏈結分享")}),T.jsx(ie,{sx:ae,onClick:Y,disabled:H==="",children:E("以圖片分享")})]})]})})}),T.jsx(pe,{anchorOrigin:{vertical:"bottom",horizontal:"center"},open:X,autoHideDuration:1500,onClose:()=>{z(!1)},message:E("已複製到剪貼簿")})]})},ne=(x,h)=>{const i=document.getElementById(x);return i?ye.toPng(i,{bgcolor:h==="light"?"#fedb00":"#000"}).then(v=>[v,i.clientHeight,i.clientWidth]):Promise.resolve(["",0,0])},Pe={isOpen:!1,isCopied:!1},be={display:"flex",alignItems:"center"},Ce={display:"flex",justifyContent:"center",outline:"none"},Ee={display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flex:1,background:x=>x.palette.background.default},Ae={display:"flex",alignItems:"center",justifyContent:"center",height:400,width:"100%"},Se={display:"flex",width:"100%",backgroundColor:x=>x.palette.background.default},ae={flex:1,border:"1px solid rgba(255, 255, 255, 0.3)"};export{Be as default};
