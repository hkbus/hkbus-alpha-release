import{j as i,r as f,A as F,e as E,G as y,P as J,o as S}from"./index-B5N-jUy8.js";import{c as G,l as I,b as _,e as T,M as B,T as V,L as k,a as H}from"./TileLayer-ISEXnMHk.js";import{S as P,C as W}from"./CompassControl-C0J87R9W.js";import{c as Z,b as A}from"./App-BP_5kTt-.js";import"./index-CJ_zZ9Gs.js";const q=Z(i.jsx("path",{d:"M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4m8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7"}),"MyLocation"),N=G(function({data:o,...r},g){const b=new I.GeoJSON(o,r);return _(b,T(g,{overlayContainer:b}))},function(o,r,g){r.style!==g.style&&(r.style==null?o.resetStyle():o.setStyle(r.style))}),D=(t,o)=>{const[r,g]=f.useState(null),{db:{routeList:b}}=f.useContext(F),{gtfsId:M,bound:$,co:h}=b[t];return f.useEffect(()=>{let p="";return M?p=`${M}-${$[h[0]]==="I"?"I":"O"}.json`:h.includes("mtr")&&(p=`${t.split("-")[0].toLowerCase()}.json`),fetch(`https://hkbus.github.io/route-waypoints/${p}`).then(d=>d.json()).then(d=>{g(d)}).catch(()=>{g({features:[{type:"Feature",geometry:{type:"LineString",coordinates:o.reduce((d,{location:{lat:C,lng:j}})=>(d.push([j,C]),d),[])}}],type:"FeatureCollection"})}),()=>{g(null)}},[t,M,$,h,o]),r},X=({onClick:t})=>i.jsx("div",{className:"leaflet-bottom leaflet-right",children:i.jsx(A,{sx:U,className:"leaflet-control leaflet-bar",onClick:t,children:i.jsx(q,{className:e.centerControl})})}),oe=({routeId:t,stopIds:o,stopIdx:r,route:g,companies:b,onMarkerClick:M})=>{var x;const{geolocation:$,geoPermission:h,updateGeoPermission:p,colorMode:d,db:{stopList:C}}=f.useContext(F),j=E(),[l,O]=f.useState(null),s=f.useMemo(()=>o.map(a=>C[a]),[C,o]),m=D(t,s),n=f.useRef({initialCenter:s[r]?s[r].location:y(),currentStopCenter:s[r]?s[r].location:y(),center:s[r]?s[r].location:y(),isFollow:!1,stops:s,stopIdx:r});f.useEffect(()=>{var w,L;let a,u;n.current.stops!==s||n.current.stopIdx!==r?a=!1:a=n.current.isFollow,n.current.stops===s&&n.current.stopIdx===r&&a?u=$:u=s[r]?s[r].location:y();const v=n.current.center;v!==u&&!J(u,v)&&(n.current.stops!==s?(w=n.current.map)==null||w.setView(u):(L=n.current.map)==null||L.flyTo(u)),n.current={...n.current,center:u,currentStopCenter:s[r]?s[r].location:y(),stops:s,stopIdx:r,isFollow:a}},[s,r,$]),f.useEffect(()=>{if(l){n.current={...n.current,map:l};const a=()=>{n.current={...n.current,center:n.current.currentStopCenter,isFollow:!1}};return l==null||l.on({dragend:a,dragstart:a}),l==null||l.setView(n.current.center),l==null||l.invalidateSize(),()=>{l.off({dragstart:a,dragend:a})}}},[l]);const R=f.useCallback(()=>{var a;h==="granted"?((a=n.current.map)==null||a.flyTo($),n.current={...n.current,center:$,isFollow:!0}):h!=="denied"&&(n.current={...n.current,isFollow:!0},p("opening"))},[h,$,p]);return i.jsx(A,{id:"route-map",sx:Q,children:i.jsxs(B,{center:n.current.initialCenter,zoom:16,scrollWheelZoom:!1,className:e.mapContainer,ref:O,children:[i.jsx(V,{crossOrigin:"anonymous",maxZoom:k.Browser.retina?20:19,maxNativeZoom:18,keepBuffer:10,updateWhenIdle:!1,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',url:d==="light"?"https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png":"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png"}),s.map((a,u)=>i.jsx(H,{position:a.location,icon:K({active:u===r,passed:u<r,companies:b}),alt:`${u}. ${a.name[j]}`,eventHandlers:{click:v=>{M(u,v)}}},`${a.location.lng}-${a.location.lat}-${u}`)),((x=m==null?void 0:m.features)==null?void 0:x.length)&&i.jsxs(i.Fragment,{children:[i.jsx(N,{data:m,style:z(b,g,!0)},m==null?void 0:m.timeStamp),i.jsx(N,{data:m,style:z(b,g,!1)},m==null?void 0:m.timeStamp)]}),i.jsx(P,{}),i.jsx(X,{onClick:R}),i.jsx(W,{})]})})},z=(t,o,r)=>function(){return{color:r?"#000000":S(t,o),weight:r?6:4,className:t.includes("ctb")&&t.includes("kmb")&&!r?e.jointlyLine:void 0}},K=({active:t,passed:o,companies:r})=>r[0]==="mtr"?k.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}):r.includes("lightRail")?k.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}):r[0].startsWith("gmb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.gmbMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}):r.includes("lrtfeeder")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.lrtfeederMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}):r.includes("nlb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.nlbMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}):r.includes("ctb")&&r.includes("kmb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.jointlyMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}):r.includes("ctb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.ctbMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}):k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.kmbMarker} ${e.marker} ${t?e.active:""} ${o?e.passed:""}`}),c="routeMap",e={mapContainerBox:`${c}-mapContainerBox`,mapContainer:`${c}-mapContainer`,centerControl:`${c}-centerControl`,marker:`${c}-marker`,mtrMarker:`${c}-mtrMarker`,gmbMarker:`${c}-gmbMarker`,ctbMarker:`${c}-ctbMarker`,jointlyMarker:`${c}-jointlyMarker`,lrtfeederMarker:`${c}-lrtfeederMarker`,nlbMarker:`${c}-nlbMarker`,kmbMarker:`${c}-kmbMarker`,jointlyLine:`${c}-jointlyLine`,active:`${c}-active`,passed:`${c}-passed`},Q={height:"35vh",filter:t=>t.palette.mode==="dark"?"brightness(0.8)":"none",[`& .${e.mapContainer}`]:{height:"35vh"},[`& .${e.mtrMarker}`]:{backgroundImage:"url(/img/mtr.svg)"},[`& .${e.gmbMarker}`]:{backgroundImage:"url(/img/minibus.svg)"},[`& .${e.ctbMarker}`]:{backgroundImage:"url(/img/bus_ctb.svg)"},[`& .${e.jointlyMarker}`]:{backgroundImage:"url(/img/bus_jointly.svg)"},[`& .${e.lrtfeederMarker}`]:{backgroundImage:"url(/img/bus_lrtfeeder.svg)"},[`& .${e.nlbMarker}`]:{backgroundImage:"url(/img/bus_nlb.svg)"},[`& .${e.kmbMarker}`]:{backgroundImage:"url(/img/bus_kmb.svg)"},[`& .${e.jointlyLine}`]:{stroke:S(["kmb"],""),animation:`${e.jointlyLine}-color 10s infinite linear 1.5s`},[`@keyframes ${e.jointlyLine}-color`]:{"50%":{stroke:S(["ctb"],"")},"100%":{stroke:S(["kmb"],"")}},[`& .${e.active}`]:{animation:"blinker 1.5s infinite"},[`& .${e.passed}`]:{filter:"grayscale(100%)"},"& .self-center":{backgroundImage:"url(/img/self.svg)",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",transition:"transform 0.1s ease-out",transformOrigin:"center"}},U={background:"white",width:32,height:32,marginBottom:"20px !important",marginRight:"5px !important",display:"flex",justifyContent:"center",alignItems:"center",[`& .${e.centerControl}`]:{padding:"3px",color:"black"}};export{oe as default};
